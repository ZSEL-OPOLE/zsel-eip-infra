# üåê Wdro≈ºenie Sieci - Kompletny Przewodnik

**Cel:** Konfiguracja MikroTik switches (4√ó CRS354, 3√ó CRS324) dla K3s cluster  
**Czas:** ~2-3 godziny  
**Poziom:** Zaawansowany  
**Status:** Production-ready

---

## üìã Co skonfigurujesz:

```
Network Infrastructure:
‚îú‚îÄ‚îÄ VLAN 110: K3s Cluster (192.168.10.0/24)
‚îÇ   ‚îú‚îÄ‚îÄ 3√ó Masters (HA etcd)
‚îÇ   ‚îú‚îÄ‚îÄ 6√ó Workers (specialized)
‚îÇ   ‚îî‚îÄ‚îÄ MetalLB pools (LoadBalancer IPs)
‚îú‚îÄ‚îÄ VLAN 600: Management (192.168.255.0/28)
‚îÇ   ‚îú‚îÄ‚îÄ 4√ó CRS354 switches
‚îÇ   ‚îú‚îÄ‚îÄ 3√ó CRS324 switches
‚îÇ   ‚îî‚îÄ‚îÄ 2√ó cAP access points
‚îî‚îÄ‚îÄ BGP Peering (AS 65000 ‚Üî AS 65001)
    ‚îú‚îÄ‚îÄ Router ‚Üí 3√ó K3s masters
    ‚îî‚îÄ‚îÄ MetalLB LoadBalancer routing
```

---

## ‚ö†Ô∏è PRZED ROZPOCZƒòCIEM

### Wymagania:
- ‚úÖ 4√ó CRS354 switches (Gigabit)
- ‚úÖ 3√ó CRS324 switches (SFP+)
- ‚úÖ 2√ó cAP access points
- ‚úÖ 9√ó Mac Pro z Ubuntu 24.04 (bond0 configured)
- ‚úÖ Laptop z dostƒôpem do switches (WinBox lub SSH)
- ‚úÖ Backup aktualnej konfiguracji

### KRYTYCZNE:
```bash
# NAJPIERW BACKUP! (na ka≈ºdym switchu)
ssh admin@192.168.255.X "/export" > backup-crsXXX-$(date +%Y%m%d).rsc
```

---

## üéØ Strategia wdro≈ºenia

### Opcja A: Terraform (Zalecane - automatyczne)
- ‚úÖ Powtarzalne
- ‚úÖ Infrastructure as Code
- ‚úÖ ≈Åatwy rollback
- ‚úÖ Version control
- ‚è±Ô∏è Czas: 30 minut

### Opcja B: Rƒôczne (Backup plan)
- ‚úÖ Pe≈Çna kontrola
- ‚ö†Ô∏è Podatne na b≈Çƒôdy
- ‚ö†Ô∏è Trudny rollback
- ‚è±Ô∏è Czas: 2-3 godziny

**Ten przewodnik:** Opcja A (Terraform) + Opcja B (manual backup)

---

## üì¶ CZƒò≈öƒÜ 1: Przygotowanie (30 minut)

### Krok 1.1: Inventory switches

**Sprawd≈∫ dostƒôpno≈õƒá wszystkich urzƒÖdze≈Ñ:**

```bash
# Lista urzƒÖdze≈Ñ (edytuj IPs je≈õli inne):
SWITCHES=(
    "192.168.1.101:crs354-01"
    "192.168.1.102:crs354-02"
    "192.168.1.103:crs354-03"
    "192.168.1.104:crs354-04"
    "192.168.1.105:crs324-01"
    "192.168.1.106:crs324-02"
    "192.168.1.107:crs324-03"
)

# Test connectivity:
for entry in "${SWITCHES[@]}"; do
    IFS=':' read -r ip name <<< "$entry"
    echo -n "$name ($ip): "
    ping -c 1 -W 2 "$ip" &>/dev/null && echo "‚úì OK" || echo "‚úó FAIL"
done
```

**Expected output:**
```
crs354-01 (192.168.1.101): ‚úì OK
crs354-02 (192.168.1.102): ‚úì OK
...
```

---

### Krok 1.2: Backup wszystkich switches

**Script automatyczny:**

```bash
#!/bin/bash
# backup-all-switches.sh

SWITCHES=(
    "192.168.1.101:crs354-01"
    "192.168.1.102:crs354-02"
    "192.168.1.103:crs354-03"
    "192.168.1.104:crs354-04"
    "192.168.1.105:crs324-01"
    "192.168.1.106:crs324-02"
    "192.168.1.107:crs324-03"
)

BACKUP_DIR="./network-backups-$(date +%Y%m%d-%H%M)"
mkdir -p "$BACKUP_DIR"

for entry in "${SWITCHES[@]}"; do
    IFS=':' read -r ip name <<< "$entry"
    echo "Backing up $name..."
    ssh -o ConnectTimeout=5 admin@"$ip" "/export" > "$BACKUP_DIR/$name-backup.rsc" 2>/dev/null
    [[ $? -eq 0 ]] && echo "‚úì $name backed up" || echo "‚úó $name FAILED"
done

echo ""
echo "Backups saved to: $BACKUP_DIR"
ls -lh "$BACKUP_DIR"
```

**Uruchom:**
```bash
chmod +x backup-all-switches.sh
./backup-all-switches.sh
```

---

### Krok 1.3: Przygotuj Terraform config

**Sprawd≈∫ czy masz wygenerowany config:**

```bash
cd zsel-eip-infra

# Sprawd≈∫ czy istnieje:
ls -lh prod-values-generated.auto.tfvars

# Powinno pokazaƒá:
# -rw-r--r-- ... prod-values-generated.auto.tfvars (generated by generate-terraform.py)
```

**Je≈õli NIE istnieje:**
```bash
# Regeneruj:
python scripts/generate-terraform.py

# Verify:
cat prod-values-generated.auto.tfvars | grep -A 5 "vlan_110"
# Powinno pokazaƒá VLAN 110 (K3s cluster)
```

---

## üöÄ CZƒò≈öƒÜ 2: Terraform Deployment (30 minut)

### Krok 2.1: Setup Terraform project

**Structure:**
```
zsel-eip-tf-infra/
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îî‚îÄ‚îÄ networking-prod/
‚îÇ       ‚îú‚îÄ‚îÄ main.tf
‚îÇ       ‚îú‚îÄ‚îÄ variables.tf
‚îÇ       ‚îú‚îÄ‚îÄ terraform.tfvars  ‚Üê EDIT THIS
‚îÇ       ‚îî‚îÄ‚îÄ prod-values.auto.tfvars  ‚Üê COPY HERE
‚îî‚îÄ‚îÄ modules/
    ‚îî‚îÄ‚îÄ mikrotik-network/
```

**Skopiuj wygenerowany config:**

```bash
# From zsel-eip-infra:
cp prod-values-generated.auto.tfvars \
   ../zsel-eip-tf-infra/environments/networking-prod/prod-values.auto.tfvars

# Verify:
cd ../zsel-eip-tf-infra/environments/networking-prod
ls -lh prod-values.auto.tfvars
```

---

### Krok 2.2: Configure provider credentials

**Edytuj `terraform.tfvars`:**

```hcl
# terraform.tfvars (WA≈ªNE: nie commituj do git!)

# Primary router (bƒôdzie obs≈Çugiwa≈Ç BGP + routing)
primary_router = {
  host     = "192.168.1.101"  # CHANGE: IP g≈Ç√≥wnego routera
  username = "admin"
  password = "YourStrongPassword123"  # CHANGE!
  insecure = true  # OK dla internal network
}

# Switches (dla VLAN configuration)
switches = [
  {
    name     = "crs354-01"
    host     = "192.168.1.101"
    username = "admin"
    password = "YourStrongPassword123"  # CHANGE!
  },
  {
    name     = "crs354-02"
    host     = "192.168.1.102"
    username = "admin"
    password = "YourStrongPassword123"
  },
  # ... repeat for all 7 switches
]
```

**‚ö†Ô∏è BEZPIECZE≈ÉSTWO:**
```bash
# NIE commituj terraform.tfvars do git!
echo "terraform.tfvars" >> .gitignore
echo "*.tfvars" >> .gitignore

# Lub u≈ºyj environment variables:
export TF_VAR_router_password="YourPassword"
```

---

### Krok 2.3: Terraform Init & Plan

```bash
# Initialize Terraform:
terraform init

# Expected output:
# Initializing provider plugins...
# - Finding kreuzwerker/routeros versions...
# - Installing kreuzwerker/routeros vX.Y.Z...

# Validate configuration:
terraform validate

# Expected: Success! The configuration is valid.

# Dry-run (see what will be created):
terraform plan

# Expected output (partial):
# Plan: 50 to add, 0 to change, 0 to destroy.
# 
# Changes:
# + routeros_interface_vlan.vlan_110 (new)
# + routeros_ip_address.vlan_110_gateway (new)
# + routeros_ip_dhcp_server.vlan_110_dhcp (new)
# + routeros_routing_bgp_instance.main (new)
# + routeros_routing_bgp_peer.k3s_master_01 (new)
# ...
```

**REVIEW CAREFULLY!** Sprawd≈∫ czy:
- ‚úÖ VLAN 110 (K3s) bƒôdzie utworzony
- ‚úÖ VLAN 600 (Management) bƒôdzie utworzony
- ‚úÖ BGP peering do 3√ó masters (192.168.10.11-13)
- ‚úÖ DHCP pools configured
- ‚úÖ QoS policies (je≈õli applicable)

---

### Krok 2.4: Apply configuration (PRODUCTION!)

**‚ö†Ô∏è PUNKT KRYTYCZNY:**

```bash
# Ostatni backup przed apply:
./backup-all-switches.sh

# Apply with confirmation:
terraform apply

# Output:
# Plan: 50 to add, 0 to change, 0 to destroy.
# Do you want to perform these actions?
#   Enter a value: yes

# ‚Üê POCZEKAJ! Przeczytaj ponownie plan!
# ‚Üê Sprawd≈∫ czy nie kasuje niczego wa≈ºnego!

# Type: yes
```

**Co siƒô dzieje (5-10 minut):**
```
[00:00] Creating VLAN 110 (K3s)
[00:30] Creating VLAN 600 (Management)
[01:00] Configuring IP addresses
[02:00] Creating DHCP servers
[03:00] Configuring BGP instance (AS 65000)
[04:00] Creating BGP peers (3√ó K3s masters)
[05:00] Adding BGP advertised networks
[06:00] Creating firewall rules (basic)
[07:00] Applying QoS policies
[08:00] Verifying configuration
[09:00] Terraform state saved
[10:00] DONE!
```

**Expected output:**
```
Apply complete! Resources: 50 added, 0 changed, 0 destroyed.

Outputs:
  vlans_created = 2
  bgp_peers_configured = 3
  dhcp_servers = 2
```

---

### Krok 2.5: Verify Terraform deployment

**Check VLAN 110:**

```bash
# SSH to primary router:
ssh admin@192.168.1.101

# Check VLANs:
/interface vlan print
# Expected:
# 0  vlan-110  bridge  110  enabled

# Check IP addresses:
/ip address print where interface=vlan-110
# Expected:
# 192.168.10.1/24  vlan-110

# Check DHCP server:
/ip dhcp-server print
# Expected:
# k3s-dhcp  vlan-110  192.168.10.200-192.168.10.254

# Check BGP peers:
/routing bgp peer print
# Expected:
# 0  k3s-master-01  192.168.10.11  65001
# 1  k3s-master-02  192.168.10.12  65001
# 2  k3s-master-03  192.168.10.13  65001
```

**Check BGP status (will be DOWN until K3s MetalLB installed):**
```
/routing bgp peer print status
# Expected (before K3s):
# 0  k3s-master-01  disabled  (no connection yet - NORMAL!)
```

---

## üîß CZƒò≈öƒÜ 3: Manual Configuration (Backup plan)

### Je≈õli Terraform nie dzia≈Ça, configure manually:

**Na primary router (CRS354-01 lub dedicated router):**

```bash
ssh admin@192.168.1.101
```

**3.1: Create VLAN 110 (K3s):**

```routeros
# Create VLAN interface:
/interface vlan add \
    name=vlan-110 \
    vlan-id=110 \
    interface=bridge

# Assign IP address:
/ip address add \
    address=192.168.10.1/24 \
    interface=vlan-110 \
    comment="K3s Cluster Gateway"

# Create DHCP pool:
/ip pool add \
    name=k3s-dhcp-pool \
    ranges=192.168.10.200-192.168.10.254

# Create DHCP server:
/ip dhcp-server add \
    name=k3s-dhcp \
    interface=vlan-110 \
    address-pool=k3s-dhcp-pool \
    lease-time=1d

# DHCP network:
/ip dhcp-server network add \
    address=192.168.10.0/24 \
    gateway=192.168.10.1 \
    dns-server=8.8.8.8,8.8.4.4 \
    comment="K3s Cluster Network"
```

**3.2: Create VLAN 600 (Management):**

```routeros
# Create VLAN interface:
/interface vlan add \
    name=vlan-600 \
    vlan-id=600 \
    interface=bridge

# Assign IP address:
/ip address add \
    address=192.168.255.1/28 \
    interface=vlan-600 \
    comment="Management Network"

# Optional: DHCP for management devices
/ip pool add \
    name=mgmt-dhcp-pool \
    ranges=192.168.255.10-192.168.255.14

/ip dhcp-server add \
    name=mgmt-dhcp \
    interface=vlan-600 \
    address-pool=mgmt-dhcp-pool
```

**3.3: Configure BGP:**

```routeros
# Create BGP instance:
/routing bgp instance add \
    name=main \
    as=65000 \
    router-id=192.168.255.1 \
    redistribute-connected=yes \
    redistribute-static=no

# Add BGP peers (K3s masters):
/routing bgp peer add \
    name=k3s-master-01 \
    instance=main \
    remote-address=192.168.10.11 \
    remote-as=65001 \
    ttl=default \
    hold-time=3m \
    keepalive-time=1m

/routing bgp peer add \
    name=k3s-master-02 \
    instance=main \
    remote-address=192.168.10.12 \
    remote-as=65001

/routing bgp peer add \
    name=k3s-master-03 \
    instance=main \
    remote-address=192.168.10.13 \
    remote-as=65001

# Advertise MetalLB networks:
/routing bgp network add \
    network=192.168.10.20/27 \
    comment="MetalLB PROD pool"

/routing bgp network add \
    network=192.168.10.101/26 \
    comment="MetalLB DEV pool"
```

**3.4: Configure trunk ports (to other switches):**

```routeros
# Example: ether1 = trunk to CRS354-02
/interface bridge port set \
    [find interface=ether1] \
    pvid=1

/interface bridge vlan add \
    bridge=bridge \
    tagged=ether1,bridge \
    vlan-ids=110,600

# Repeat for all trunk ports (ether1-ether10, sfp+1-4, etc.)
```

**3.5: Configure access ports (to Mac Pros):**

```routeros
# Example: ether11-ether19 = Mac Pros (VLAN 110)
/interface bridge port
set [find interface=ether11] pvid=110
set [find interface=ether12] pvid=110
# ... repeat for ether11-ether19

# Add to VLAN membership:
/interface bridge vlan add \
    bridge=bridge \
    untagged=ether11,ether12,ether13,ether14,ether15,ether16,ether17,ether18,ether19 \
    vlan-ids=110
```

---

## ‚úÖ CZƒò≈öƒÜ 4: Weryfikacja (15 minut)

### Test 1: VLAN connectivity

**Z laptop (pod≈ÇƒÖcz do VLAN 110 port):**

```bash
# Get DHCP IP:
sudo dhclient eth0

# Should get: 192.168.10.200-254

# Test gateway:
ping 192.168.10.1
# Expected: Reply from 192.168.10.1

# Test DNS:
nslookup google.com
# Expected: 8.8.8.8 response
```

---

### Test 2: Mac Pro connectivity

**Na ka≈ºdym Mac Pro (po konfiguracji bond0):**

```bash
# Test gateway:
ping 192.168.10.1
# Expected: Reply

# Test other nodes:
ping 192.168.10.11  # master-01
ping 192.168.10.14  # worker-01

# Test Internet:
ping 8.8.8.8
ping google.com
```

**All-to-all connectivity test:**

```bash
#!/bin/bash
# test-connectivity.sh

NODES=(192.168.10.{11..19})

for src in "${NODES[@]}"; do
    echo "Testing from $src..."
    ssh admin@"$src" "
        for dst in ${NODES[@]}; do
            [[ \$dst == $src ]] && continue
            ping -c 1 -W 2 \$dst &>/dev/null && echo \"  ‚Üí \$dst: OK\" || echo \"  ‚Üí \$dst: FAIL\"
        done
    "
done
```

---

### Test 3: BGP status (after K3s MetalLB installed)

**Na router:**

```bash
ssh admin@192.168.1.101

# Check BGP peers:
/routing bgp peer print status

# Expected (after MetalLB deployed):
# 0  k3s-master-01  established  uptime: 2m30s  prefix-count: 2
# 1  k3s-master-02  established  uptime: 2m25s  prefix-count: 2
# 2  k3s-master-03  established  uptime: 2m20s  prefix-count: 2

# Check received routes:
/routing bgp advertisements print peer=k3s-master-01

# Expected:
# 192.168.10.20/27  (MetalLB PROD pool)
# 192.168.10.101/26 (MetalLB DEV pool)
```

**‚ö†Ô∏è Przed MetalLB:** BGP peers bƒôdƒÖ w stanie "disabled" lub "connect" - TO NORMALNE!

---

### Test 4: DHCP leases

**Na router:**

```bash
/ip dhcp-server lease print

# Expected:
# ADDRESS         MAC-ADDRESS       HOST-NAME        SERVER
# 192.168.10.11   xx:xx:xx:xx:xx   k3s-master-01    k3s-dhcp  (static)
# 192.168.10.12   xx:xx:xx:xx:xx   k3s-master-02    k3s-dhcp  (static)
# ...
```

---

## üî• CZƒò≈öƒÜ 5: Troubleshooting

### Problem: VLAN 110 nie dzia≈Ça

```routeros
# Check VLAN interface:
/interface vlan print detail
# Should show: vlan-110, running=yes

# Check bridge VLAN filtering:
/interface bridge print
# Should show: vlan-filtering=yes

# Check VLAN membership:
/interface bridge vlan print where vlan-ids=110
# Should list all ports
```

**Fix:**
```routeros
# Enable VLAN filtering:
/interface bridge set bridge vlan-filtering=yes

# Force VLAN update:
/interface bridge vlan remove [find vlan-ids=110]
# Re-add (see manual config above)
```

---

### Problem: Mac Pro nie dostaje IP (DHCP)

```routeros
# Check DHCP server status:
/ip dhcp-server print
# Should show: k3s-dhcp, disabled=no

# Check DHCP leases:
/ip dhcp-server lease print
# Should show active leases

# Check logs:
/log print where topics~"dhcp"
```

**Fix:**
```routeros
# Restart DHCP server:
/ip dhcp-server disable k3s-dhcp
/ip dhcp-server enable k3s-dhcp

# Or delete & recreate (see manual config)
```

---

### Problem: BGP nie ustanawia po≈ÇƒÖczenia

```routeros
# Check BGP logs:
/log print where topics~"bgp"

# Common errors:
# "connection refused" ‚Üí K3s MetalLB not running yet (NORMAL!)
# "TTL exceeded" ‚Üí TTL too low (change to 255)
# "AS mismatch" ‚Üí Check remote-as (should be 65001)
```

**Fix TTL:**
```routeros
/routing bgp peer set k3s-master-01 ttl=255
/routing bgp peer set k3s-master-02 ttl=255
/routing bgp peer set k3s-master-03 ttl=255
```

**Fix if MetalLB not installed yet:**
```
Wait until K3s + MetalLB deployed.
BGP will connect automatically when MetalLB starts.
```

---

### Problem: Internet nie dzia≈Ça z VLAN 110

```routeros
# Check NAT (Masquerade):
/ip firewall nat print

# Should have:
# chain=srcnat out-interface=<WAN> action=masquerade

# If missing:
/ip firewall nat add \
    chain=srcnat \
    out-interface=<WAN> \
    action=masquerade \
    comment="Internet access for internal networks"
```

---

### Problem: Terraform apply fails

**Common errors:**

1. **Connection timeout:**
   ```
   Error: timeout connecting to 192.168.1.101
   ```
   Fix: Check switch IP, SSH access, firewall

2. **Resource already exists:**
   ```
   Error: VLAN 110 already exists
   ```
   Fix: Import existing resource or delete manually

3. **Authentication failed:**
   ```
   Error: authentication failed for admin@192.168.1.101
   ```
   Fix: Check password in terraform.tfvars

**Import existing resources:**
```bash
# If VLAN 110 already exists:
terraform import routeros_interface_vlan.vlan_110 vlan-110

# If IP address exists:
terraform import routeros_ip_address.vlan_110_gateway *ADDRESS_ID*

# Find ID:
ssh admin@192.168.1.101 "/ip address print"
```

---

## üîÑ CZƒò≈öƒÜ 6: Rollback (if needed)

### Option A: Terraform destroy

```bash
# Remove all Terraform-managed resources:
terraform destroy

# Confirm: yes

# Then restore from backup:
scp network-backups-DATE/crs354-01-backup.rsc admin@192.168.1.101:/
ssh admin@192.168.1.101 "/import crs354-01-backup.rsc"
```

---

### Option B: Manual rollback

```routeros
# Remove VLAN 110:
/interface vlan remove [find name=vlan-110]

# Remove IP addresses:
/ip address remove [find interface=vlan-110]

# Remove DHCP:
/ip dhcp-server remove [find name=k3s-dhcp]
/ip pool remove [find name=k3s-dhcp-pool]

# Remove BGP:
/routing bgp peer remove [find name~"k3s"]
/routing bgp instance remove [find name=main]

# Import backup:
/import crs354-01-backup.rsc
```

---

## üìä Checklist: Network deployment

```
[ ] Preparation (30 min)
    [ ] Inventory all switches
    [ ] Backup all configurations
    [ ] Generate Terraform config
    [ ] Test connectivity

[ ] Terraform Deployment (30 min)
    [ ] Setup Terraform project
    [ ] Configure provider credentials
    [ ] terraform init
    [ ] terraform plan (REVIEW!)
    [ ] terraform apply (PRODUCTION!)
    [ ] Verify VLANs created

[ ] Manual Configuration (if Terraform fails)
    [ ] Create VLAN 110 (K3s)
    [ ] Create VLAN 600 (Management)
    [ ] Configure BGP
    [ ] Configure trunk ports
    [ ] Configure access ports

[ ] Verification (15 min)
    [ ] Test VLAN connectivity
    [ ] Test Mac Pro connectivity
    [ ] Test all-to-all (9 nodes)
    [ ] Check DHCP leases
    [ ] Check BGP status (after MetalLB)

[ ] Troubleshooting (if issues)
    [ ] Check VLAN filtering
    [ ] Check DHCP server
    [ ] Check BGP logs
    [ ] Check NAT/Internet
    [ ] Import backup if needed

[ ] Documentation
    [ ] Save Terraform state
    [ ] Document IP assignments
    [ ] Update network diagram
    [ ] Save final backup
```

---

## üìû Next Steps

**After network deployment:**

1. **Install K3s** (see `scripts/README-SCRIPTS.md`)
   ```bash
   # Masters:
   curl -sfL https://get.k3s.io | sh -s - server --cluster-init
   
   # Workers:
   curl -sfL https://get.k3s.io | K3S_URL=https://192.168.10.11:6443 sh -
   ```

2. **Deploy MetalLB** (BGP speaker)
   ```bash
   kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml
   ```

3. **Configure MetalLB pools** (from vlans-master.yaml)
   ```yaml
   apiVersion: metallb.io/v1beta1
   kind: IPAddressPool
   metadata:
     name: prod-pool
   spec:
     addresses:
     - 192.168.10.20-192.168.10.51
   ```

4. **Test LoadBalancer** (create test service)
   ```bash
   kubectl create deployment nginx --image=nginx
   kubectl expose deployment nginx --type=LoadBalancer --port=80
   kubectl get svc nginx
   # Should get IP from 192.168.10.20-51
   ```

5. **Deploy applications** (ArgoCD)
   ```bash
   kubectl apply -f apps/argocd-root/application.yaml
   ```

**Gotowy wdra≈ºaƒá sieƒá?** üöÄ

```bash
# Start here:
cd zsel-eip-infra/scripts
./backup-all-switches.sh
cd ../../zsel-eip-tf-infra/environments/networking-prod
terraform init
terraform plan
```
